const map = new mapboxgl.Map({
    container: 'map',
    center: [136.534, 34.844644],
    zoom: 14,
    style: {
      version: 8,
      sources: {
        OSM: {
          type: "raster",
          tiles: [
            "https://a.tile.openstreetmap.org/{z}/{x}/{y}.png",
          ],
          tileSize: 256,
          attribution:
          "OpenStreetMap",
        },
      },
      layers: [{
        id: "BASEMAP",
        type: "raster",
        source: "OSM",
        minzoom: 0,
        maxzoom: 18,
      }],
    },      
  });
  
  const waypoints = [
    [136.53890132904053,34.844644908488974],
    [136.54332160949704,34.840242190008105],
    [136.54332160949704,34.83950251019765],
    [136.54269933700562,34.838956551788414],
    [136.54169082641602,34.83962579062764],
    [136.54085397720337,34.8406296386847],
    [136.5396952629089,34.840876195983945],
    [136.53905153274533,34.84207374950346],
    [136.53836488723752,34.84233791337538],
    [136.53733491897583,34.84247880042707],
    [136.53692722320557,34.843024735474586],
    [136.53722763061523,34.84397571045787],
    [136.53709888458252,34.844609687675614],
    [136.53624057769775,34.84496189513088],
    [136.53475999832153,34.84497950546407],
    [136.53355836868286,34.844239868225415],
    [136.53252840042114,34.843271285599414],
    [136.53070449829102,34.843148010629314],
    [136.53042554855347,34.844556856427346],
    [136.53010368347168,34.845948067986726],
    [136.53066158294678,34.84698705874748],
    [136.53055429458618,34.84719837729692],
    [136.5302324295044,34.847145547710426],
    [136.529803276062,34.84665246993445],
    [136.5293526649475,34.84605372866326],
    [136.52864456176758,34.845490203487564],
    [136.52759313583374,34.845384542087515],
    [136.52628421783447,34.845595864751935],
    [136.525297164917,34.84596567810891],
    [136.52458906173703,34.84651159002726],
    [136.5241813659668,34.8472512068495],
    [136.52381658554077,34.848043646068255],
    [136.52345180511475,34.8483606196191],
    [136.52261495590207,34.8483606196191],
    [136.52190685272217,34.84799081702441],
    [136.52212142944336,34.847304036368136],
    [136.52287244796753,34.84665246993445],
    [136.52392387390137,34.846176999281084],
    [136.52482509613037,34.8457895767176],
    [136.52570486068726,34.84536693184101],
    [136.52673482894897,34.84504994675916],
    [136.52780771255493,34.84478579159165],
    [136.52898788452148,34.84445119382902],
    [136.529803276062,34.844239868225415],
    [136.53027534484863,34.844098984188236],
    [136.531240940094,34.843852436542846],
    [136.53194904327393,34.84399332100207],
    [136.53265714645386,34.84436314156012],
    [136.5330862998962,34.84469773968073],
    [136.53368711471558,34.845173218880525],
    [136.53418064117432,34.84563108514324],
    [136.5346097946167,34.84580718687367],
    [136.53531789779663,34.846088948858615],
    [136.53559684753418,34.846018508452836],
    [136.5357255935669,34.8457895767176],
    [136.53600454330444,34.84603611855993],
    [136.53656244277954,34.84607133876282],
    [136.53714179992676,34.84598328822732],
    [136.53769969940186,34.84570152588064],
    [136.53817176818848,34.845314101078806],
    [136.5387511253357,34.84480340196252]
  ];
  
  // Symbol Layer
  const symbolData = {
      'type': 'FeatureCollection',
      'features': []
  };
  map.on('load', function() {
    map.loadImage(
      'https://img.icons8.com/material/32/0000FF/marker--v1.png',
      (error, image) => {
        if (error) {
          throw error;
        }
        map.addImage('iconA', image);
        map.addSource('point', {
          'type': 'geojson',
          'data': symbolData
        });
        map.addLayer({
          'id': 'points',
          'type': 'symbol',
          'source': 'point',
          'layout': {
            'icon-image': 'iconA',
            'icon-size': 1,
            'icon-allow-overlap': true,
            'icon-ignore-placement': true,          
          }
        });
        
        time = new Date().getTime();
        animate();
      }
    );
  });
  
  const line = turf.lineString(waypoints);
  const lineLength = turf.length(line, { units: 'meters' });
  
  const kph = 600; // 600km/h
  let time = null;
  let distance = 0;
  
  function animate() {
    // 1フレームで移動する距離を算出
    const now = new Date().getTime();
    const offset = now - time;
    time = now;
    const movingInMeters = ((kph / 60 / 60 / 1000) * offset) * 1000;
    
    // 移動距離加算
    distance = distance + movingInMeters;
  
    // 移動した点を計算
    const options = {units: 'meters'};
    const movedPoint = turf.along(line, distance, options);
  
    // 更新
    symbolData.features.splice(0);
    symbolData.features.push({
      'type': 'Feature',
      'geometry': {
        'type': 'Point',
        'coordinates': movedPoint.geometry.coordinates
      }
    });
    const dataSource = map.getSource('point');
    dataSource.setData(symbolData);
    
    // repeat
    if (distance >= lineLength) {
        distance = 0;
    }
          
    requestAnimationFrame(animate);
  }
  